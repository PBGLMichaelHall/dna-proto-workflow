%% Generated by Sphinx.
\def\sphinxdocclass{article}
\documentclass[letterpaper,10pt,english]{sphinxhowto}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax

\PassOptionsToPackage{warn}{textcomp}
\usepackage[utf8]{inputenc}
\ifdefined\DeclareUnicodeCharacter
% support both utf8 and utf8x syntaxes
  \ifdefined\DeclareUnicodeCharacterAsOptional
    \def\sphinxDUC#1{\DeclareUnicodeCharacter{"#1}}
  \else
    \let\sphinxDUC\DeclareUnicodeCharacter
  \fi
  \sphinxDUC{00A0}{\nobreakspace}
  \sphinxDUC{2500}{\sphinxunichar{2500}}
  \sphinxDUC{2502}{\sphinxunichar{2502}}
  \sphinxDUC{2514}{\sphinxunichar{2514}}
  \sphinxDUC{251C}{\sphinxunichar{251C}}
  \sphinxDUC{2572}{\textbackslash}
\fi
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}
\usepackage{babel}



\usepackage{times}
\expandafter\ifx\csname T@LGR\endcsname\relax
\else
% LGR was declared as font encoding
  \substitutefont{LGR}{\rmdefault}{cmr}
  \substitutefont{LGR}{\sfdefault}{cmss}
  \substitutefont{LGR}{\ttdefault}{cmtt}
\fi
\expandafter\ifx\csname T@X2\endcsname\relax
  \expandafter\ifx\csname T@T2A\endcsname\relax
  \else
  % T2A was declared as font encoding
    \substitutefont{T2A}{\rmdefault}{cmr}
    \substitutefont{T2A}{\sfdefault}{cmss}
    \substitutefont{T2A}{\ttdefault}{cmtt}
  \fi
\else
% X2 was declared as font encoding
  \substitutefont{X2}{\rmdefault}{cmr}
  \substitutefont{X2}{\sfdefault}{cmss}
  \substitutefont{X2}{\ttdefault}{cmtt}
\fi


\usepackage[Bjarne]{fncychap}
\usepackage{sphinx}

\fvset{fontsize=\small}
\usepackage{geometry}


% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}

\addto\captionsenglish{\renewcommand{\contentsname}{Contents:}}

\usepackage{sphinxmessages}
\setcounter{tocdepth}{4}
\setcounter{secnumdepth}{4}


\title{dna\sphinxhyphen{}proto\sphinxhyphen{}workflow}
\date{Dec 03, 2020}
\release{}
\author{Norman Warthmann}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{Version 1.0}
\makeindex
\begin{document}

\pagestyle{empty}

        \pagenumbering{Roman} %%% to avoid page 1 conflict with actual page 

        \begin{titlepage}
            \vspace*{10mm} %%% * is used to give space from top
            \flushright\textbf{\Huge {PBGL-NGS-Analysis-Workflow v1.0}}

            \vspace{0mm} %%% * is used to give space from top
            \textbf{\Large {A Laboratory Manual}}

            \vspace{50mm}
            \textbf{\Large {Norman Warthmann}}

            \vspace{10mm}
            \textbf{\Large {Plant Breeding and Genetics Laboratory}}
            
            \vspace{0mm}
            \textbf{\Large {FAO/IAEA Joint Division}}

            \vspace{0mm}
            \textbf{\Large {Seibersdorf, Austria}}

	    \vspace{10mm}
            \normalsize Created: July, 2020

            \vspace*{0mm}
            \normalsize  Last updated: 24 November 2020

            %% \vfill adds at the bottom
            \vfill
            \small\flushleft {{\textbf {Please note:}} \textit {This is not an official IAEA publication but is made available as working material. The material has not undergone an official review by the IAEA. The views
expressed do not necessarily reflect those of the International Atomic Energy Agency or its Member States and remain the responsibility of the contributors. The use of particular designations of countries or territories does not imply any judgement by the publisher, the IAEA, as to the legal status of such countries or territories, of their authorities and institutions or of the delimitation of their boundaries. The mention of names of specific companies or products (whether or not indicated as registered) does not imply any intention to infringe proprietary rights, nor should it be construed as an endorsement or recommendation on the part of the IAEA.}}
        \end{titlepage}

        \pagenumbering{arabic}
        \newcommand{\sectionbreak}{\clearpage}

\pagestyle{plain}
\sphinxtableofcontents
\pagestyle{normal}
\phantomsection\label{\detokenize{index::doc}}



\section{Overview PBGL’s Mutant\sphinxhyphen{}Analysis\sphinxhyphen{}workflow}
\label{\detokenize{index:overview-pbgl-s-mutant-analysis-workflow}}
This collection of Snakemake rules constitutes a workflow for the analysis of high\sphinxhyphen{}throughput sequencing projects. We use it mostly for genome re\sphinxhyphen{}sequencing data produced with Illumina\sphinxhyphen{}type sequencing instruments.
For this particular workflow we distinguish two different use cases: \sphinxstylestrong{denovo} and \sphinxstylestrong{varcall}. The workflow is designed to run the entire analyses automatically.


\subsection{The (brief) principle of Snakemake}
\label{\detokenize{index:the-brief-principle-of-snakemake}}
In Snakemake, analysis workflows are defined as a series of rules. In our case, rules define the analysis steps. Each rule has input and output files. Calling a rule will invoke all necessary upstream rules. It is hence generally sufficient to request the desired output file(s) of the downstream most rule and the entire workflow will be executed.
In practice, users will provide input files, configure project meta information, adjust configuration parameters, and execute \sphinxcode{\sphinxupquote{snakemake}}. The workflow will then automatically perform all the (necessary) analysis steps to produce the defined output.

In general, a rule will be run if:
\begin{itemize}
\item {} 
Snakemake realizes that the expected output files of a rule are not (yet) present, or

\item {} 
Snakemake realizes that the expected input files or configuration parameters of a rule have changed since the last run.

\end{itemize}

Hence, when analyses are re\sphinxhyphen{}run, existing and valid intermediate output files from a previous run are re\sphinxhyphen{}used, saving precious time and resources.
For details, please consult the \sphinxhref{https://snakemake.readthedocs.io/en/stable/index.html\#}{Snakemake} documentation. For the differente use cases in this workflow, invoke the rule that produces the desired output.


\subsection{Mutant\sphinxhyphen{}Analysis\sphinxhyphen{}workflow Use Cases}
\label{\detokenize{index:mutant-analysis-workflow-use-cases}}

\subsubsection{De\sphinxhyphen{}Novo Analysis of sample relatedness (“denovo”)}
\label{\detokenize{index:de-novo-analysis-of-sample-relatedness-denovo}}
Choosing this option will conduct a reference\sphinxhyphen{}free comparison of \sphinxstyleemphasis{samples} based on the raw sequencing reads using k\sphinxhyphen{}mers. The workflow invokes the software tools kWIP and/or mash and outputs distance matrices and PCA plots. A flowchart illustrating the summarised workflow is depicted in \sphinxstylestrong{Figure 1}. The workflow for this use case consists of the following steps:


\begin{savenotes}\sphinxattablestart
\centering
\begin{tabulary}{\linewidth}[t]{|T|T|T|T|}
\hline
\sphinxstyletheadfamily 
\#
&\sphinxstyletheadfamily 
Task
&\sphinxstyletheadfamily 
Rule
&\sphinxstyletheadfamily 
Software
\\
\hline
1
&
Prepare/clip the raw reads
&
readQC
&
AdapterRemoval
\\
\hline
2
&
Calculate distances
&
denovo
&
kWIP and/or mash
\\
\hline
3
&
Perform PCA and plot
&
denovo
&
Utils/R\sphinxhyphen{}Scripts
\\
\hline
\end{tabulary}
\par
\sphinxattableend\end{savenotes}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[height=600\sphinxpxdimen]{{de-novo-02}.png}
\caption{\sphinxstylestrong{Figure 1.} flowchart for “denovo” (click to expand)}\label{\detokenize{index:id9}}\end{figure}
\begin{itemize}
\item {} 
Invoke this option by running the rule: \sphinxcode{\sphinxupquote{rules.denovo.input}}

\end{itemize}

Required input for \sphinxcode{\sphinxupquote{rules.denovo.input}} are fastq files and the workflow will return distance matrices between \sphinxstyleemphasis{samples} produced by kWIP and/or mash.

\textgreater{} NOTE: We recommend performing such denovo analysis for every project. Clustering at the level of sequencing runs can be used to confirm metadata and detect mixups.


\subsubsection{Variant Calling \sphinxhyphen{} Standard Re\sphinxhyphen{}Sequencing Analysis (“varcall”)}
\label{\detokenize{index:variant-calling-standard-re-sequencing-analysis-varcall}}
Choosing this option will run a full re\sphinxhyphen{}sequencing analysis ending in filtered bcf/vcf files. It detects variants and genotypes in \sphinxstyleemphasis{sets} of \sphinxstyleemphasis{samples} based on the alignments of the sequencing reads against one or several user\sphinxhyphen{}defined reference genome(s). Reads can be aligned with bwa and/or NextGenMap (ngm), and variants can be called with freebayes and/or mpileup. Between read alignments and variant calling, PCR duplicates are marked (with samtools markdup) and indels are realigned (using abra2). If reference genome annotation is provided, the effects of variants on gene integrity can also be predicted using the software \sphinxhref{https://pcingola.github.io/SnpEff/se\_introduction/}{snpEff}. A flowchart illustrating the summarised workflow is depicted in \sphinxstylestrong{Figure 2}

The full workflow for this use case consists of the following steps:


\begin{savenotes}\sphinxattablestart
\centering
\begin{tabulary}{\linewidth}[t]{|T|T|T|T|}
\hline
\sphinxstyletheadfamily 
\#
&\sphinxstyletheadfamily 
Task
&\sphinxstyletheadfamily 
Rule
&\sphinxstyletheadfamily 
Software
\\
\hline
1
&
Prepare/clip the raw reads
&
readQC
&
AdapterRemoval
\\
\hline
2
&
Align the reads to the reference genome
&
align
&
bwa and/or ngm
\\
\hline
3
&
Mark duplicates
&
align
&
samtools fixmate 
samtools sort    
samtools markdup
\\
\hline
4
&
Realign indels
&
align
&
samtools merge   
abra2
\\
\hline
5
&
Call variants
&
varcall
&
freebayes and/or mpileup
\\
\hline
6
&
Filter variants
&
varcall
&
bcftools view
\\
\hline
7
&
Annotate variants
&
annotate
&
snpEff
\\
\hline
\end{tabulary}
\par
\sphinxattableend\end{savenotes}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[height=600\sphinxpxdimen]{{dna-proto-workflow-varcall-11}.png}
\caption{\sphinxstylestrong{Figure 2.} flowchart for “varcall” (click to expand)}\label{\detokenize{index:id10}}\end{figure}

This option can be invoked in 2 ways:
\begin{itemize}
\item {} 
selecting \sphinxcode{\sphinxupquote{rules.varcall.input}} will result in one or several \sphinxstylestrong{vcf files}, one for each combination of sample\sphinxhyphen{}set, reference genome, read aligner, variant caller, and variant filter.

\item {} 
selecting the rule \sphinxcode{\sphinxupquote{rules.annotate.input}} will result in one or several \sphinxstylestrong{annotated vcf files} and additional summaries; running  \sphinxcode{\sphinxupquote{rules.annotate.input}} is only meaningful when a genome annotations is available and provided in form of a snpEff database. Currently, only one reference genome annotation can be provided at a time. Hence, invoking the variant calling workflow through \sphinxcode{\sphinxupquote{rules.annotate.input}}, will restrict the  workflow upstream to only one reference genome.

\end{itemize}

Required input files are fastq files and a genome reference sequence(s) (fasta). The rule \sphinxcode{\sphinxupquote{snpeff}} in addition depends on a genome annotation in form of a snpEff database matching the reference genome. For maximum flexibility and ease of troubleshooting we recommend to first run the re\sphinxhyphen{}sequencing analysis by invoking \sphinxcode{\sphinxupquote{rules.varcall.input}}, and upon successful completion invoke the workflow again, this time selecting/uncommenting \sphinxcode{\sphinxupquote{rules.annotate.input}}.


\subsubsection{Variant Annotation \sphinxhyphen{} The Effects of Variants on Gene Function (“annotate”)}
\label{\detokenize{index:variant-annotation-the-effects-of-variants-on-gene-function-annotate}}
Choosing the option \sphinxcode{\sphinxupquote{rules.annotate.input}} will annotate bcf/vcf files found in \sphinxstylestrong{output/variants/final/} and write annotated vcf.gz files to \sphinxstylestrong{output/variants\_annotated/}. This analysis has only one step:


\begin{savenotes}\sphinxattablestart
\centering
\begin{tabulary}{\linewidth}[t]{|T|T|T|T|}
\hline
\sphinxstyletheadfamily 
\#
&\sphinxstyletheadfamily 
Task
&\sphinxstyletheadfamily 
Rule
&\sphinxstyletheadfamily 
Software
\\
\hline
1
&
Annotate variants
&
annotate
&
snpEff
\\
\hline
\end{tabulary}
\par
\sphinxattableend\end{savenotes}

Typically, \sphinxcode{\sphinxupquote{rules.annotate.input}} is run after a completed run of \sphinxcode{\sphinxupquote{rules.varcall.input}}. A snpEff run will complete within a matter of minutes. It will run on all files specified by entries in the \sphinxcode{\sphinxupquote{snpeff:}} section of the \sphinxcode{\sphinxupquote{config.yml}} file:
\begin{itemize}
\item {} 
\sphinxcode{\sphinxupquote{config{[}snpeff:{]}{[}ref:{]}}} one chosen reference genome,

\item {} 
\sphinxcode{\sphinxupquote{config{[}snpeff:{]}{[}database:{]}}} one corresponding snpEff database,

\end{itemize}

and all combinations of specified \sphinxcode{\sphinxupquote{samplesets}}, read \sphinxcode{\sphinxupquote{aligners}}, variant \sphinxcode{\sphinxupquote{callers}}, and variant \sphinxcode{\sphinxupquote{filter}} settings.


\subsection{Hardware Requirements}
\label{\detokenize{index:hardware-requirements}}
The workflow is parallelised and Snakemake will make efficient use of available resources on local machines as well as on compute clusters. It will run faster the more resources are available, but it performs fine on smaller machines. For routine applications we have used the workflow on a budged workstation, HP Z820 with 32 cores, 64 GB RAM running Ubuntu 16.04, and on a Virtual Machine in the cloud, AZURE with 16 cores and 512 GB RAM running Ubuntu 18.04.

Snakemake allows for fine\sphinxhyphen{}tuning resource allocation to the individual rules, i.e., number of processors and memory. We configured each rule with reasonable defaults, but they can be tailored to your particular size project and hardware. For details please consult the \sphinxhref{https://snakemake.readthedocs.io/en/stable/index.html\#}{Snakemake} documentation. In general though, if limited by memory, then do not parallelise too aggressively.


\subsection{Software Dependencies}
\label{\detokenize{index:software-dependencies}}
We recommend running the workflow in its own \sphinxcode{\sphinxupquote{conda environment}} on a Linux Server. Dependencies are listed in \sphinxcode{\sphinxupquote{envs/condaenv.yml}} and \sphinxcode{\sphinxupquote{envs/additional.yml}}. A brief explanation how to use these files to generate the conda environment is further below. For comprehensive explanation please consult the \sphinxhref{https://docs.conda.io/projects/conda/en/latest/user-guide/getting-started.html}{conda} documentation. For software that is not available through conda on some important platforms we make the specific binaries available in \sphinxcode{\sphinxupquote{envs/}}; currently mainly abra2.jar.


\section{Workflow Use in a Nutshell}
\label{\detokenize{index:workflow-use-in-a-nutshell}}

\subsection{Steps}
\label{\detokenize{index:steps}}\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
Create a new github repository in your github account using this workflow \sphinxhref{https://help.github.com/en/articles/creating-a-repository-from-a-template}{as a template}

\item {} 
\sphinxhref{https://help.github.com/en/articles/cloning-a-repository}{Clone} your newly created repository to your local system where you want to perform the analysis

\item {} 
Create and activate the conda environment

\item {} 
Provide reference genome(s) and annotation(s) in \sphinxcode{\sphinxupquote{/genomes and annotation/}}

\item {} 
Specify the locations of input files and their meta data in \sphinxcode{\sphinxupquote{/metadata/sample2runlib.csv}}

\item {} 
Provide lists of samples as sets to analyse in \sphinxcode{\sphinxupquote{metadata/samplesets/}}

\item {} 
Uncomment the respective workflow option for your use case in the \sphinxcode{\sphinxupquote{Snakefile}}

\item {} 
Configure software parameters in \sphinxcode{\sphinxupquote{config.yml}}

\item {} 
Adapt \sphinxcode{\sphinxupquote{snpeff.config}} (Optional in case the \sphinxcode{\sphinxupquote{snpeff}} rule will be called)

\item {} 
Run \sphinxcode{\sphinxupquote{snakemake}}

\end{enumerate}

For standard applications no additional edits are necessary. The rules reside in \sphinxcode{\sphinxupquote{rules/*.smk}}. Most rules have explicit shell commands with transparent flag settings. Expert users can change these for additional control.


\section{Workflow Use in Detail}
\label{\detokenize{index:workflow-use-in-detail}}

\subsection{Creating the Virtual Environment (conda)}
\label{\detokenize{index:creating-the-virtual-environment-conda}}
We recommend running the workflow in its own conda environment on a Linux machine. The files \sphinxcode{\sphinxupquote{envs/condaenv.yml}} and \sphinxcode{\sphinxupquote{envs/additional.yml}} can directly be used to create the environment and install dependencies like so (“dna\sphinxhyphen{}proto” is an example, feel free to chose your own):

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} conda create \PYGZhy{}\PYGZhy{}name dna\PYGZhy{}proto
\PYGZdl{} conda env update \PYGZhy{}\PYGZhy{}name dna\PYGZhy{}proto \PYGZhy{}\PYGZhy{}file condaenv.yml
\PYGZdl{} conda env update \PYGZhy{}\PYGZhy{}name dna\PYGZhy{}proto \PYGZhy{}\PYGZhy{}file additional.yml
\PYGZdl{} conda activate dna\PYGZhy{}proto
\end{sphinxVerbatim}

If \sphinxcode{\sphinxupquote{env update}} does not work as intended or fails, then \sphinxcode{\sphinxupquote{conda install}} the programs manually. Specify the correct channel and software version where required. Below we give examples, but please consult the \sphinxhref{https://docs.conda.io/projects/conda/en/latest/user-guide/getting-started.html}{conda} (and \sphinxhref{https://bioconda.github.io/}{bioconda}) documentation.

Example:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} conda install \PYGZhy{}c bioconda samtools=1.9
\end{sphinxVerbatim}

In case of manual installs, it is convenient to add all required channels to the \sphinxcode{\sphinxupquote{conda config}}. To install the dependencies you will need below channels.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} conda config \PYGZhy{}\PYGZhy{}show channels
channels:
      \PYGZhy{} defaults
      \PYGZhy{} bioconda
      \PYGZhy{} conda\PYGZhy{}forge
      \PYGZhy{} r
\PYGZdl{} conda config \PYGZhy{}\PYGZhy{}add channels bioconda
\PYGZdl{} conda install samtools=1.9
\end{sphinxVerbatim}

The required channels are listed in the respective \sphinxcode{\sphinxupquote{*.yml}} files. Configuring channels has the pitfall of rare ambiguities and collisions. Please consult the \sphinxhref{https://docs.conda.io/projects/conda/en/latest/user-guide/getting-started.html}{conda} documentation for “managing channels”.


\subsection{Reference Genome(s)}
\label{\detokenize{index:reference-genome-s}}
The workflow will look for the reference genome(s) and associated files in \sphinxcode{\sphinxupquote{genomes\_and\_annotations/}}. We provide an example directory tree in \sphinxcode{\sphinxupquote{genomes\_annotations/readme}}. We recommend creating a separate directory for each reference genome. They can be soft links. Each reference genome directory must contain the necessary assembly file (.fa or .fna) and the associated files required by the aligners. Generate those files in this directory from the assembly file (fasta: .fa or .fna) like so:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} samtools faidx \PYGZlt{}reference\PYGZhy{}genome.fa\PYGZgt{}
\PYGZdl{} bwa index \PYGZhy{}a bwtsw \PYGZlt{}reference\PYGZhy{}genome.fa\PYGZgt{}
\PYGZdl{} ngm \PYGZhy{}r \PYGZlt{}reference\PYGZhy{}genome.fa\PYGZgt{}
\end{sphinxVerbatim}

\# directory tree of the reference genome directory when fully prepared

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZti{}/genomes\PYGZus{}and\PYGZus{}annotations/
├── GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1
   ├── GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1\PYGZus{}genomic.fna
   ├── GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1\PYGZus{}genomic.fna.amb
   ├── GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1\PYGZus{}genomic.fna.ann
   ├── GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1\PYGZus{}genomic.fna.bwt
   ├── GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1\PYGZus{}genomic.fna\PYGZhy{}enc.2.ngm
   ├── GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1\PYGZus{}genomic.fna.fai
   ├── GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1\PYGZus{}genomic.fna\PYGZhy{}ht\PYGZhy{}13\PYGZhy{}2.3.ngm
   ├── GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1\PYGZus{}genomic.fna.pac
   └── GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1\PYGZus{}genomic.fna.sa
\end{sphinxVerbatim}


\subsection{Reference Genome Annotation}
\label{\detokenize{index:reference-genome-annotation}}
In order to annotate variant effects using snpEff you will need a snpEff database (\sphinxcode{\sphinxupquote{snpEffectPredictor.bin}}) for the relevant reference genome. The location of the \sphinxcode{\sphinxupquote{snpeff}} database is configured in \sphinxcode{\sphinxupquote{snpeff.config}}. It is set to \sphinxcode{\sphinxupquote{genomes\_and\_annotations/snpeffdata/}} and again, we recommend separate subdirectories for the reference genomes also in this directory. Appending “\_snpeff” to these directory names will help avoid confusion. In order to create a \sphinxcode{\sphinxupquote{snpeff}} database, this \sphinxcode{\sphinxupquote{\textless{}reference\_genome\textgreater{}\_snpeff}} directory must contain the reference genome and the annotation in files named \sphinxcode{\sphinxupquote{sequences.fa}} and \sphinxcode{\sphinxupquote{genes.gff}}; they again can be soft links. (See \sphinxcode{\sphinxupquote{genomes\_and\_annotations/snpeffdata/readme}}.)

Below is an example directory tree of \sphinxcode{\sphinxupquote{genomes\_and\_annotations/}} for a cowpea reference genome downloaded from NCBI. Notice that we store the reference genomes elsewhere and use soft links. Compare also to our entries in \sphinxcode{\sphinxupquote{snpeff.config}} under “Non\sphinxhyphen{}standard Databases” and replicate accordingly. The database \sphinxcode{\sphinxupquote{snpEffectPredictor.bin}} will be generated by \sphinxcode{\sphinxupquote{snpEff build}}.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
genomes\PYGZus{}and\PYGZus{}annotations/
├── GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1 \PYGZhy{}\PYGZgt{} \PYGZti{}/genomes/GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1/
├── readme
└── snpeffdata
    └── GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1\PYGZus{}snpeff
        ├── genes.gff \PYGZhy{}\PYGZgt{} \PYGZti{}/genomes/GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1/GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1\PYGZus{}genomic.gff
        ├── genes.gtf \PYGZhy{}\PYGZgt{} \PYGZti{}/genomes/GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1/GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1\PYGZus{}genomic.gtf
        ├── protein.fa \PYGZhy{}\PYGZgt{} \PYGZti{}/genomes/GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1/GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1\PYGZus{}protein.faa
        ├── sequences.fa \PYGZhy{}\PYGZgt{} \PYGZti{}/genomes/GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1/GCF\PYGZus{}004118075.1\PYGZus{}ASM411807v1\PYGZus{}genomic.fna
        └── snpEffectPredictor.bin
\end{sphinxVerbatim}

For building the database you will need to add the respective entry in \sphinxcode{\sphinxupquote{snpeff.config}} and execute:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} snpEff build \PYGZhy{}c \PYGZlt{}path to snpEff.config\PYGZgt{} \textendash{}gff3 \PYGZlt{}reference\PYGZhy{}genome\PYGZgt{}\PYGZus{}snpeff
\end{sphinxVerbatim}

The target for snpEff build is the directory name only. The path to this directory (genomes\_and\_annotations/snpeffdata/) is specified in \sphinxcode{\sphinxupquote{snpEff.config}}. If executed from the top level workflow directory (the directory that contains the \sphinxcode{\sphinxupquote{snpeff.config}} file), specifying the location of \sphinxcode{\sphinxupquote{snpEff.config}} (\sphinxhyphen{}c) is not necessary.
While a \sphinxcode{\sphinxupquote{.gtf}} file can also be used (\sphinxhyphen{}gtf 22), we have better experience building databases from \sphinxcode{\sphinxupquote{.gff}} files. For a detailed explanation of the \sphinxcode{\sphinxupquote{snpeff}} build process please consult the \sphinxhref{https://pcingola.github.io/SnpEff/se\_introduction/}{snpEff} documentation.


\subsection{Providing Required Meta information}
\label{\detokenize{index:providing-required-meta-information}}

\subsubsection{Samplesets}
\label{\detokenize{index:samplesets}}
We use the term \sphinxstyleemphasis{sample} as the entity of interest. Our workflows call variants on \sphinxstyleemphasis{samples} within one \sphinxstyleemphasis{set}. Lists of sample names must be provided as text files (\sphinxcode{\sphinxupquote{.txt}}) in \sphinxcode{\sphinxupquote{/metadata/samplesets/}}. Each file defines a set. The \sphinxcode{\sphinxupquote{samplesets}} in \sphinxcode{\sphinxupquote{config.yml}} refer to those files and must match the filenames. We implemented a glob: \sphinxstyleemphasis{all\_samples}, which will have the effect of concatenating all \sphinxcode{\sphinxupquote{*.txt}} files in \sphinxcode{\sphinxupquote{/metadata/samplesets/}} into an additional set comprising all samples across all sets. The intention is to enable easy addition or removal of samples to/from an existing analysis.


\subsubsection{Sample Definitions}
\label{\detokenize{index:sample-definitions}}
In practice, the unit of interest oftentimes is the individual (plant). DNA is extracted from an individual and turned into one or several sequencing libraries that are then sequenced in one or several sequencing runs. In order to compare individuals, all respective fastq files need to be assigned to the same \sphinxstyleemphasis{sample}. For our workflow, the run \sphinxhyphen{} library \sphinxhyphen{} sample relationships need to be defined in \sphinxcode{\sphinxupquote{/metadata/sample2runlib.csv}} making explicit which fastq files constitute the samples.
The entries in columns \sphinxstyleemphasis{run} and \sphinxstyleemphasis{library} are together used as the primary key for the \sphinxstylestrong{sequencing run} and thus the fastq file(s). The user must make sure that any \sphinxstyleemphasis{run} \sphinxhyphen{} \sphinxstyleemphasis{library} combination is unique.
\sphinxstylestrong{Sequencing runs} are assigned to the same \sphinxstyleemphasis{sample} through an identical entry in the \sphinxstyleemphasis{sample} column. fastq files can be provided either as separate forward and reverse read files (\sphinxstyleemphasis{fq1}, \sphinxstyleemphasis{fq2}) or as interleaved fastq (\sphinxstyleemphasis{il\_fq}), with the respective other column(s) empty. Within one \sphinxcode{\sphinxupquote{sample2runlib.csv}} file interleaved and two\sphinxhyphen{}file input can be mixed.

Example \sphinxcode{\sphinxupquote{sample2runlib.csv}} file:


\begin{savenotes}\sphinxattablestart
\centering
\begin{tabulary}{\linewidth}[t]{|T|T|T|T|T|T|}
\hline
\sphinxstyletheadfamily 
run
&\sphinxstyletheadfamily 
library
&\sphinxstyletheadfamily 
sample
&\sphinxstyletheadfamily 
fq1
&\sphinxstyletheadfamily 
fq2
&\sphinxstyletheadfamily 
il\_fq
\\
\hline
Run1
&
A\sphinxhyphen{}500bp
&
A
&
\textless{}path to file\textgreater{}
&
\textless{}path to file\textgreater{}
&\\
\hline
Run1
&
A\sphinxhyphen{}300bp
&
A
&
\textless{}path to file\textgreater{}
&
\textless{}path to file\textgreater{}
&\\
\hline
Run2
&
A\sphinxhyphen{}500bp
&
A
&
\textless{}path to file\textgreater{}
&
\textless{}path to file\textgreater{}
&\\
\hline
Run2
&
B\sphinxhyphen{}300bp
&
B
&&&
\textless{}path to file\textgreater{}
\\
\hline
Run1
&
B\sphinxhyphen{}500bp
&
B
&&&
\textless{}path to file\textgreater{}
\\
\hline
Run1
&
C\sphinxhyphen{}500bp
&
C
&
\textless{}path to file\textgreater{}
&
\textless{}path to file\textgreater{}
&\\
\hline
\end{tabulary}
\par
\sphinxattableend\end{savenotes}


\subsubsection{Regions of Interest for Variant Calling}
\label{\detokenize{index:regions-of-interest-for-variant-calling}}
Variant calling can be restricted to particular regions of interest through \sphinxcode{\sphinxupquote{metadata/contigs\_of\_interest.bed}}: A file in bed file format listing identifier, start\sphinxhyphen{}, and end\sphinxhyphen{}positions (tab delimited, no header). This is helpful for exome capture data but also to restrict the analysis to specific chromosomes. Genome assemblies often contain the main chromosomes and in addition many orphan fragments that often are not of interest.
Below example will restrict variant calling to the 11 chromosomes plus the chloroplast of cowpea. The hundreds of additional contigs in the cowpea reference genome are available for read mapping, but variants will not be called for them and their variants will subsequently not be present in the bcf/vcf files. Note that lines starting with ‘\#’ will be disregarded.

Example \sphinxcode{\sphinxupquote{contigs\_of\_interest.bed}} file:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{NC\PYGZus{}040279}\PYG{o}{.}\PYG{l+m+mi}{1} \PYG{l+m+mi}{0} \PYG{l+m+mi}{42129361}
\PYG{n}{NC\PYGZus{}040280}\PYG{o}{.}\PYG{l+m+mi}{1} \PYG{l+m+mi}{0} \PYG{l+m+mi}{33908088}
\PYG{n}{NC\PYGZus{}040281}\PYG{o}{.}\PYG{l+m+mi}{1} \PYG{l+m+mi}{0} \PYG{l+m+mi}{65292630}
\PYG{n}{NC\PYGZus{}040282}\PYG{o}{.}\PYG{l+m+mi}{1} \PYG{l+m+mi}{0} \PYG{l+m+mi}{42731077}
\PYG{n}{NC\PYGZus{}040283}\PYG{o}{.}\PYG{l+m+mi}{1} \PYG{l+m+mi}{0} \PYG{l+m+mi}{48746289}
\PYG{n}{NC\PYGZus{}040284}\PYG{o}{.}\PYG{l+m+mi}{1} \PYG{l+m+mi}{0} \PYG{l+m+mi}{34463471}
\PYG{n}{NC\PYGZus{}040285}\PYG{o}{.}\PYG{l+m+mi}{1} \PYG{l+m+mi}{0} \PYG{l+m+mi}{40876636}
\PYG{n}{NC\PYGZus{}040286}\PYG{o}{.}\PYG{l+m+mi}{1} \PYG{l+m+mi}{0} \PYG{l+m+mi}{38363498}
\PYG{n}{NC\PYGZus{}040287}\PYG{o}{.}\PYG{l+m+mi}{1} \PYG{l+m+mi}{0} \PYG{l+m+mi}{43933251}
\PYG{n}{NC\PYGZus{}040288}\PYG{o}{.}\PYG{l+m+mi}{1} \PYG{l+m+mi}{0} \PYG{l+m+mi}{41327797}
\PYG{n}{NC\PYGZus{}040289}\PYG{o}{.}\PYG{l+m+mi}{1} \PYG{l+m+mi}{0} \PYG{l+m+mi}{41684185}
\PYG{n}{NC\PYGZus{}018051}\PYG{o}{.}\PYG{l+m+mi}{1} \PYG{l+m+mi}{0} \PYG{l+m+mi}{152415}
\end{sphinxVerbatim}


\subsection{Workflow Configuration}
\label{\detokenize{index:workflow-configuration}}

\subsubsection{config.yml}
\label{\detokenize{index:config-yml}}
Central place for the user to configure the workflow behaviour and software parameters is \sphinxcode{\sphinxupquote{config.yml}}. There are comments in the file that explain the configuration parameters and options.

In Snakemake, calling a rule will trigger running of the upstream rules. When editing \sphinxcode{\sphinxupquote{(/config.yml)}} it is important to only configure the intended most downstream rule (\sphinxcode{\sphinxupquote{varcall:}}, \sphinxcode{\sphinxupquote{annotate:}}, or \sphinxcode{\sphinxupquote{denovo:}}). These settings will be propagated upstream. \sphinxcode{\sphinxupquote{qc:}} is independent and will require editing: particularly the \sphinxcode{\sphinxupquote{\_DEFAULT\_}} adaptors used. The standard adaptors for Truseq\sphinxhyphen{} and Nextera\sphinxhyphen{}Libraries are given for reference, paste under \sphinxcode{\sphinxupquote{\_DEFAULT\_}} as required.

An important configuration parameter is the location of a suitable temporary directory (“tmp/”). Several rules make extensive use of the “tmp/” directory to temporarily store large files. Oftentimes, standard home directories on compute servers or cluster nodes are too small. Central place for the configuration of the “tmp/” directory is currently under the abra2 configuration options (\sphinxcode{\sphinxupquote{abra2:temp:}}).


\subsubsection{Additional Configuration}
\label{\detokenize{index:additional-configuration}}
Expert users can change the rules themselves by editing \sphinxcode{\sphinxupquote{rules/*.rules.smk}}. Use caution! We have chosen reasonable default settings and recommend modifying rules only when you know what you are doing. When allocating more cores to rules, pay attention that some rules are very memory intensive and some shell commands are piped and are in fact using more than 1 core per process.


\subsubsection{Running the Workflow}
\label{\detokenize{index:running-the-workflow}}
To run the workflow, un\sphinxhyphen{}comment the respective rule for the desired use case in the \sphinxcode{\sphinxupquote{Snakefile}} and run snakemake.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} snakemake \textendash{}npr
\PYGZdl{} snakemake \textendash{}j 6 \PYGZhy{}\PYGZhy{}notemp \PYGZhy{}kpr
\end{sphinxVerbatim}

For details on commandline options for snakemake please consult the \sphinxhref{https://snakemake.readthedocs.io/en/stable/index.html\#}{Snakemake} documentation. Un\sphinxhyphen{}comment only the one most downstream rule for your use case. Currently, these use case rules are:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} USER OPTIONS}
\PYG{c+c1}{\PYGZsh{}     rules.denovo.input,}
\PYG{c+c1}{\PYGZsh{}     rules.varcall.input,}
\PYG{c+c1}{\PYGZsh{}     rules.annotate.input,}
\end{sphinxVerbatim}

A rule that encounters missing input files will invoke the respective upstream rule(s). E.g., when \sphinxcode{\sphinxupquote{rules.annotate.input}} is uncommented and snakemake is run for the first time, the entire workflow from \sphinxcode{\sphinxupquote{readqc}} (= adapter and quality clipping), \sphinxcode{\sphinxupquote{align}} (= read alignments, duplicate marking, indel realignment), \sphinxcode{\sphinxupquote{varcall}} (= variant calling), and \sphinxcode{\sphinxupquote{annotate}} (= variant functional annotation) will run in one go.
In case no \sphinxcode{\sphinxupquote{snpeff}} database is supplied, then rule \sphinxcode{\sphinxupquote{rules.annotate.input}} cannot be run. Use \sphinxcode{\sphinxupquote{rules.varcall.input}} instead.

When configuring \sphinxcode{\sphinxupquote{config.yml}}, keep in mind that configuration parameters of a downstream rule take precedence because parameters have to propagate upstream. I.e., When running \sphinxcode{\sphinxupquote{varcall}}, the user must set alignment parameters in the \sphinxcode{\sphinxupquote{varcall:}} section; same for \sphinxcode{\sphinxupquote{annotate:}} parameters. They must be set under \sphinxcode{\sphinxupquote{snpeff:}}.

\textgreater{}NOTE: Adjusting presumed upstream parameters, e.g., under \sphinxcode{\sphinxupquote{align:}} will not have the intended effect. Only in special circumstances will the \sphinxcode{\sphinxupquote{rules.align.input}} be run by itself and only then will you have to adjust parameters in the \sphinxcode{\sphinxupquote{align:}} section.

The workflow runs on \sphinxstyleemphasis{samples} in \sphinxstyleemphasis{sets} as listed in \sphinxcode{\sphinxupquote{samplesets/*.txt}} and defined in \sphinxcode{\sphinxupquote{/metadata/sample2runlib.csv}}. Sample names listed in \sphinxcode{\sphinxupquote{samplesets/*.txt}} must correspond to the entries in the sample column in \sphinxcode{\sphinxupquote{/metadata/sample2runlib.csv}}.


\subsection{Configuring the different Workflow Use Cases}
\label{\detokenize{index:configuring-the-different-workflow-use-cases}}

\subsubsection{De\sphinxhyphen{}Novo Analysis of sample relatedness (“denovo”)}
\label{\detokenize{index:id6}}
Option \sphinxstylestrong{denovo} can be used to check the relatedness of \sphinxstyleemphasis{sequencing runs} and/or \sphinxstyleemphasis{samples} without the use of any reference genome. It will perform a comparative analysis based on k\sphinxhyphen{}mers on the raw data and output distance matrices. We recommend performing a de\sphinxhyphen{}novo analysis at the very start of every project at the “sequencing run”\sphinxhyphen{}level prior to any merging of runs into samples. This can help to detect mix\sphinxhyphen{}ups and mislabels. Run\sphinxhyphen{}level clustering is achieved by providing unique names for each sequencing run in the sample column of \sphinxcode{\sphinxupquote{metadata/sample2runlib.csv}}. De\sphinxhyphen{}novo analysis is invoked by calling \sphinxcode{\sphinxupquote{rules.denovo.input}} (Uncomment the respective line in the \sphinxcode{\sphinxupquote{Snakefile}}, and only this line). Pay attention to maintain the indentation.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{rule} \PYG{n+nb}{all}\PYG{p}{:}
    \PYG{n+nb}{input}\PYG{p}{:}
\PYG{c+c1}{\PYGZsh{} USER OPTIONS}
            \PYG{n}{rules}\PYG{o}{.}\PYG{n}{denovo}\PYG{o}{.}\PYG{n}{input}\PYG{p}{,}
\PYG{c+c1}{\PYGZsh{}            rules.varcall.input,}
\PYG{c+c1}{\PYGZsh{}            rules.annotate.input,}
\PYG{c+c1}{\PYGZsh{} EXPERT OPTIONS}
\PYG{c+c1}{\PYGZsh{}            rules.readqc.input,}
\PYG{c+c1}{\PYGZsh{}            rules.align.input,}
\PYG{c+c1}{\PYGZsh{}            rules.stats.input,}
\end{sphinxVerbatim}


\subsubsection{Variant Calling \sphinxhyphen{} Standard Re\sphinxhyphen{}Sequencing Analysis (“varcall”)}
\label{\detokenize{index:id7}}
Running \sphinxcode{\sphinxupquote{rules.varcall.input}} will call variants and genotype \sphinxstyleemphasis{samples} with respect to one or several reference genomes. \sphinxstylestrong{varcall} will compare \sphinxstyleemphasis{samples} listed in \sphinxcode{\sphinxupquote{metadata/samplesets/}} with one another, as defined in the sample column. Invoke this analysis by uncommenting \sphinxcode{\sphinxupquote{rules.varcall.input}} (and only this line). Pay attention to maintain the indentation.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{rule} \PYG{n+nb}{all}\PYG{p}{:}
    \PYG{n+nb}{input}\PYG{p}{:}
\PYG{c+c1}{\PYGZsh{} USER OPTIONS}
\PYG{c+c1}{\PYGZsh{}        rules.denovo.input,}
        \PYG{n}{rules}\PYG{o}{.}\PYG{n}{varcall}\PYG{o}{.}\PYG{n}{input}\PYG{p}{,}
\PYG{c+c1}{\PYGZsh{}        rules.annotate.input,}
\PYG{c+c1}{\PYGZsh{} EXPERT OPTIONS}
\PYG{c+c1}{\PYGZsh{}        rules.readqc.input,}
\PYG{c+c1}{\PYGZsh{}        rules.align.input,}
\PYG{c+c1}{\PYGZsh{}        rules.stats.input,}
\end{sphinxVerbatim}


\subsubsection{Variant Annotation \sphinxhyphen{} The Effects of Variants on Gene Function (“annotate”)}
\label{\detokenize{index:id8}}
If a snpEff library for this (exact) reference genome is provided then the entire workflow can in principle be invoke by uncommenting \sphinxcode{\sphinxupquote{rules.annotate.input}} (and only this line). Pay attention to maintain the correct indentation.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{rule} \PYG{n+nb}{all}\PYG{p}{:}
    \PYG{n+nb}{input}\PYG{p}{:}
\PYG{c+c1}{\PYGZsh{} USER OPTIONS}
\PYG{c+c1}{\PYGZsh{}       rules.denovo.input,}
\PYG{c+c1}{\PYGZsh{}       rules.varcall.input,}
       \PYG{n}{rules}\PYG{o}{.}\PYG{n}{annotate}\PYG{o}{.}\PYG{n}{input}\PYG{p}{,}
\PYG{c+c1}{\PYGZsh{} EXPERT OPTIONS}
\PYG{c+c1}{\PYGZsh{}       rules.readqc.input,}
\PYG{c+c1}{\PYGZsh{}       rules.align.input,}
\PYG{c+c1}{\PYGZsh{}       rules.stats.input,}
\end{sphinxVerbatim}

Currently, \sphinxcode{\sphinxupquote{rules.annotate.input}} will operate only on one reference genome at a time. The rule will hence propagate upstream only one reference genome as requirement. If variants detected against several different reference genomes need annotating, then first run the \sphinxcode{\sphinxupquote{varcall}} rule specifying all reference genomes and subsequently invoke the \sphinxcode{\sphinxupquote{annotate}} rule separately for each reference genome annotation.


\subsubsection{Expert Options}
\label{\detokenize{index:expert-options}}
In cases where only adapter clipping or read alignment is desired, those processes can be invoked separately by the respective rules,  \sphinxcode{\sphinxupquote{rules.readqc.input}} or \sphinxcode{\sphinxupquote{rules.align.input}}. There are separate configurations sections for those in \sphinxcode{\sphinxupquote{config.yml}} which must be used. Alignment will trigger prior adaptor clipping.
Invoking \sphinxcode{\sphinxupquote{rules.stats.input}} will produce summary statistics. They will require read alignments and are meaningful for generic \sphinxstylestrong{varcall} runs.


\section{Workflow Outputs}
\label{\detokenize{index:workflow-outputs}}
After completion, all output of the workflow, including logs and stats, will be in \sphinxcode{\sphinxupquote{output/}}.
\begin{itemize}
\item {} 
Clipped reads (in interleaved fastq format) are in \sphinxcode{\sphinxupquote{output/reads/}}

\item {} 
BAM files with In/Del\sphinxhyphen{}realigned alignments are in \sphinxcode{\sphinxupquote{output/abra/}}

\item {} 
BCF/VCF files of the filtered variants including respective index files are in \sphinxcode{\sphinxupquote{output/variants/final/}}

\item {} 
The snpEff\sphinxhyphen{}annotated variant file is in \sphinxcode{\sphinxupquote{output/annotated\_variants/snpeff/}}

\end{itemize}

VCF files in \sphinxcode{\sphinxupquote{output/variants/final/}} have been filtered with \sphinxstyleemphasis{bcftools view} according to the user defined filter settings in \sphinxcode{\sphinxupquote{config.yml}}.
For loading into IGV, use the In/Del realigned BAM file in \sphinxcode{\sphinxupquote{output/abra/}} and the \sphinxcode{\sphinxupquote{*.vcf.gz}} files of the filtered variants. Note that IGV requires the \sphinxcode{\sphinxupquote{vcf.gz.tbi}} index.


\section{Support}
\label{\detokenize{index:support}}

\subsection{Contributors}
\label{\detokenize{index:contributors}}
This workflow was developed by Norman Warthmann of the Plant Breeding and Genetics Laboratory of the FAO/IAEA Joint Division (PBGL), with important contributions from Kevin D Murray (Australian National University) and Marcos Conde, PBGL. The documentation was written by Norman Warthmann with contributions from Anibal Morales, PBGL.


\subsection{Citing}
\label{\detokenize{index:citing}}
When publishing results obtained using this workflow please cite the link to the original github repository specifying the release.


\subsection{Reproducibility}
\label{\detokenize{index:reproducibility}}
Workflows help addressing reproducibility issues. Consider making your version of the workflow, configured for your data, available upon publication of your results. Check out the \sphinxhref{https://snakemake.readthedocs.io/en/stable/snakefiles/deployment.html\#sustainable-and-reproducible-archiving}{archive} options of Snakemake.


\subsection{Getting Help}
\label{\detokenize{index:getting-help}}
Feel free to let us know if you are using our workflow and don’t hesitate to contact us with questions: email \sphinxstylestrong{n.warthmann@iaea.org}



\renewcommand{\indexname}{Index}
\printindex
\end{document}